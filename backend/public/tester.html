<!doctype html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>AI Generator Tester</title>
  <style>
    body { font-family: sans-serif; max-width: 1100px; margin: 20px auto; }
    label { display: block; margin-top: 12px; font-weight: bold; }
    textarea { width: 100%; height: 120px; font-size: 14px; }
    select, input, button { padding: 8px; font-size: 14px; }
    .row { display: flex; gap: 12px; align-items: center; margin-top: 12px; }
    .result, pre { background: #f5f5f5; padding: 12px; border-left: 4px solid #4CAF50; margin-top: 10px; }
    .conv-item { background: #fff; border: 1px solid #ddd; padding: 10px; margin: 6px 0; cursor: pointer; border-radius: 4px; }
    .conv-item:hover { background: #f9f9f9; }
    .conv-item.active { border-color: #4CAF50; background: #e8f5e9; }
    .section { margin-top: 30px; padding: 15px; background: #fafafa; border-radius: 6px; }
    .badge { display: inline-block; padding: 4px 10px; background: #2196F3; color: white; border-radius: 12px; font-size: 12px; margin-left: 8px; }
    .info { color: #666; font-size: 13px; }
    #conversationsList { max-height: 300px; overflow-y: auto; margin-top: 10px; }
    .message { padding: 8px; margin: 4px 0; border-radius: 4px; }
    .message.user { background: #e3f2fd; border-left: 3px solid #2196F3; }
    .message.assistant { background: #f1f8e9; border-left: 3px solid #8BC34A; }
    .message-role { font-weight: bold; font-size: 12px; text-transform: uppercase; margin-bottom: 4px; }
  </style>
</head>
<body>
  <h1>ü§ñ AI Generator Tester con Conversazioni</h1>

  <div class="section">
    <h2>‚öôÔ∏è Configurazione</h2>
    
    <label>Company ID
      <input id="companyId" type="number" value="1" />
    </label>

    <div class="row">
      <button id="loadTones">Carica toni</button>
      <span id="tonesStatus"></span>
    </div>

    <label>Tono
      <select id="toneSelect"></select>
    </label>
  </div>

  <div class="section">
    <h2>üí¨ Conversazioni</h2>
    <div class="row">
      <button id="loadConversations">Carica conversazioni</button>
      <button id="newConversation">‚ûï Nuova conversazione</button>
      <span id="convStatus"></span>
    </div>
    <div class="info">
      Conversazione attiva: <strong id="currentConvId">Nessuna (verr√† creata al primo invio)</strong>
    </div>
    <div id="conversationsList"></div>
  </div>

  <div class="section">
    <h2>‚úçÔ∏è Genera Contenuto</h2>
    <label>Prompt utente</label>
    <textarea id="prompt" placeholder="Scrivi qui il tuo prompt (es: Scrivi un'email di presentazione del prodotto)">Scrivi un'email di presentazione del prodotto.</textarea>

    <div class="row">
      <button id="generate">üöÄ Genera</button>
      <span id="genStatus"></span>
    </div>

    <h3>Risultato</h3>
    <div class="result" id="output">Nessun risultato ancora...</div>
  </div>

  <div class="section">
    <h2>üìú Storico Conversazione Corrente</h2>
    <div id="messagesHistory">Nessun messaggio ancora...</div>
  </div>

  <script>
    const toneSelect = document.getElementById('toneSelect');
    const companyIdEl = document.getElementById('companyId');
    const promptEl = document.getElementById('prompt');
    const tonesStatus = document.getElementById('tonesStatus');
    const genStatus = document.getElementById('genStatus');
    const output = document.getElementById('output');
    const convStatus = document.getElementById('convStatus');
    const conversationsList = document.getElementById('conversationsList');
    const currentConvIdEl = document.getElementById('currentConvId');
    const messagesHistory = document.getElementById('messagesHistory');

    let currentConversationId = null;
    let conversations = [];

    async function extractErrorText(res) {
      // Try parse JSON error, otherwise return trimmed text (strip HTML tags) limited length
      try {
        const json = await res.clone().json();
        return (json && (json.error || JSON.stringify(json))) || res.statusText;
      } catch (_e) {
        try {
          const txt = await res.clone().text();
          // strip simple HTML tags for readability
          const stripped = txt.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
          return stripped.length > 300 ? stripped.slice(0, 300) + '...' : stripped || res.statusText;
        } catch (_e2) {
          return res.statusText;
        }
      }
    }

    // tryCount: number of attempts left (default 1 retry)
    async function loadTones(tryCount = 1) {
      const companyId = companyIdEl.value;
      tonesStatus.textContent = 'Carico...';
      toneSelect.innerHTML = '';
      
      try {
        const res = await fetch(`/toni?company_id=${encodeURIComponent(companyId)}`);
        if (!res.ok) {
          const msg = await extractErrorText(res);
          throw new Error(msg);
        }
        const data = await res.json();
        (data.tones || []).forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.name;
          opt.textContent = `${t.name} ‚Äî ${t.instructions || ''}`;
          toneSelect.appendChild(opt);
        });
        tonesStatus.textContent = `‚úÖ ${(data.tones || []).length} toni caricati`;
      } catch (err) {
        if (tryCount > 0) {
          // breve ritardo e retry una volta
          setTimeout(() => loadTones(tryCount - 1), 300);
          tonesStatus.textContent = `‚è≥ Ritento...`;
          return;
        }
        tonesStatus.textContent = `‚ùå Errore: ${err.message}`;
      }
    }

    async function loadConversations(tryCount = 1) {
      const companyId = companyIdEl.value;
      convStatus.textContent = 'Carico conversazioni...';
      conversationsList.innerHTML = '';
      
      try {
        const res = await fetch(`/conversazioni?company_id=${encodeURIComponent(companyId)}`);
        if (!res.ok) {
          const msg = await extractErrorText(res);
          throw new Error(msg);
        }
        conversations = await res.json();
        
        if (conversations.length === 0) {
          conversationsList.innerHTML = '<div class="info">Nessuna conversazione trovata. Inizia generando un contenuto!</div>';
        } else {
          conversations.forEach(conv => {
            const div = document.createElement('div');
            div.className = 'conv-item';
            if (conv.id === currentConversationId) div.classList.add('active');
            
            const title = conv.title || `Conversazione #${conv.id}`;
            const date = new Date(conv.updated_at).toLocaleString('it-IT');
            
            div.innerHTML = `
              <strong>${title}</strong>
              <span class="badge">ID: ${conv.id}</span>
              <div class="info">Ultimo aggiornamento: ${date}</div>
            `;
            
            div.onclick = () => selectConversation(conv.id);
            conversationsList.appendChild(div);
          });
        }
        
        convStatus.textContent = `‚úÖ ${conversations.length} conversazioni caricate`;
      } catch (err) {
        if (tryCount > 0) {
          setTimeout(() => loadConversations(tryCount - 1), 300);
          convStatus.textContent = `‚è≥ Ritento...`;
          return;
        }
        convStatus.textContent = `‚ùå Errore: ${err.message}`;
      }
    }

    function selectConversation(convId) {
      currentConversationId = convId;
      currentConvIdEl.textContent = `ID ${convId}`;
      currentConvIdEl.style.color = '#4CAF50';
      
      // Aggiorna la visualizzazione
      document.querySelectorAll('.conv-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.closest('.conv-item')?.classList.add('active');
      
      messagesHistory.innerHTML = '<div class="info">Continua questa conversazione inviando un nuovo prompt!</div>';
    }

    function newConversation() {
      currentConversationId = null;
      currentConvIdEl.textContent = 'Nessuna (verr√† creata al primo invio)';
      currentConvIdEl.style.color = '';
      messagesHistory.innerHTML = 'Nessun messaggio ancora...';
      output.textContent = 'Pronto per una nuova conversazione...';
      
      document.querySelectorAll('.conv-item').forEach(item => {
        item.classList.remove('active');
      });
      
      convStatus.textContent = '‚ú® Pronto per nuova conversazione';
    }

    function displayMessages(userPrompt, assistantResponse) {
      const userDiv = document.createElement('div');
      userDiv.className = 'message user';
      userDiv.innerHTML = `<div class="message-role">üë§ User</div>${userPrompt}`;
      
      const assistantDiv = document.createElement('div');
      assistantDiv.className = 'message assistant';
      assistantDiv.innerHTML = `<div class="message-role">ü§ñ Assistant</div>${assistantResponse}`;
      
      if (messagesHistory.textContent.includes('Nessun messaggio')) {
        messagesHistory.innerHTML = '';
      }
      
      messagesHistory.appendChild(userDiv);
      messagesHistory.appendChild(assistantDiv);
      
      // Scroll to bottom
      messagesHistory.scrollTop = messagesHistory.scrollHeight;
    }

    async function generate() {
      const body = {
        prompt: promptEl.value,
        tone: toneSelect.value,
        company_id: Number(companyIdEl.value)
      };
      
      // Aggiungi conversation_id se esiste
      if (currentConversationId) {
        body.conversation_id = currentConversationId;
      }
      
      genStatus.textContent = '‚è≥ Genero...';
      output.textContent = 'Elaborazione in corso...';
      
      try {
        const res = await fetch('/genera', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || res.statusText);
        
        output.textContent = data.text || JSON.stringify(data);
        genStatus.textContent = '‚úÖ Fatto';
        
        // Aggiorna conversation_id se √® stata creata una nuova conversazione
        if (data.conversation_id && data.conversation_id !== currentConversationId) {
          currentConversationId = data.conversation_id;
          currentConvIdEl.textContent = `ID ${currentConversationId}`;
          currentConvIdEl.style.color = '#4CAF50';
          
          // Ricarica la lista delle conversazioni
          await loadConversations();
        }
        
        // Mostra i messaggi nello storico
        displayMessages(promptEl.value, data.text);
        
        // Pulisci il prompt per il prossimo messaggio
        promptEl.value = '';
        promptEl.placeholder = 'Continua la conversazione o modifica il contenuto precedente...';
        
      } catch (err) {
        genStatus.textContent = `‚ùå Errore: ${err.message}`;
        output.textContent = `Errore: ${err.message}`;
      }
    }

    document.getElementById('loadTones').onclick = loadTones;
    document.getElementById('generate').onclick = generate;
    document.getElementById('loadConversations').onclick = loadConversations;
    document.getElementById('newConversation').onclick = newConversation;

    // Autocarica toni e conversazioni all'avvio
    loadTones();
    loadConversations();
  </script>
</body>
</html>