Nexum PoC — Setup e Documentazione Completa

Panoramica
- Framework: Rails 8.1.1 (Ruby 3.4.8)
- Database: PostgreSQL
- AI: Amazon Bedrock (Converse API, modello predefinito "amazon.nova-lite-v1:0")
- Storage: Active Storage (locale in dev, configurabile)
- Code paths principali:
  - Servizi AI: app/services/ai_service.rb, app/services/document_analysis_service.rb
  - API: config/routes.rb, app/controllers/generator_controller.rb, app/controllers/documents_controller.rb
  - Modelli dati: app/models/* (Company, Tone, Conversation, Message, Document)
  - Job di analisi: app/jobs/analyze_document_job.rb
  - Config Bedrock: config/bedrock.yml + config/initializers/bedrock_config.rb
  - Pagine di test: public/tester.html (generazione conversazionale), public/documentTester.html (analisi documenti)

Prerequisiti (Windows)
- Ruby 3.4.x + Bundler
- PostgreSQL (es. v14+)
- Accesso AWS Bedrock nella regione configurata
- Opzionale: libvips/ImageMagick per varianti immagini (gem image_processing)

Variabili d’ambiente (sviluppo con .env) DA COPIARE IN UN FILE .env che viene ignorato da git
AWS_ACCESS_KEY_ID= ...
AWS_SECRET_ACCESS_KEY= ...
AWS_SESSION_TOKEN= ...


Database
- Config predefinita in config/database.yml:
  - development/test: utente postgres, password "2909", host localhost, porta 5432
  - production: stessa base con database separati per cache/queue/cable
- Puoi usare `DATABASE_URL` per sovrascrivere la connessione.

Setup Locale (Dev)
1) Installare dipendenze
   - Installare Ruby, Bundler, PostgreSQL
2) Installare gem
   - Apri terminale nella root del progetto
   - Esegui:
     bundle install
3) Configurare variabili ambiente
   - Crea .env (grazie a dotenv-rails) con chiavi AWS e modelli Bedrock
4) Inizializzare database
   - Esegui:
     bin/rails db:create
     bin/rails db:migrate
     bin/rails db:seed
   - Il seed crea una Company (ID=1), alcuni Tone e una conversazione di esempio
5) Avviare server
   - Esegui:
     bin/rails s
   - Visita: http://localhost:3000/tester.html (generazione) e http://localhost:3000/documentTester.html (analisi)

API — Endpoints
- POST /genera
  - Body (JSON): { "prompt": string, "tone": string, "company_id": number, "conversation_id": number? }
  - Risposta: { "text": string, "conversation_id": number }
  - Note: mantiene contesto conversazionale via `conversation_id`.
- GET /toni?company_id=ID
  - Risposta: { company: {id, name}, tones: [ {id, name, instructions} ] }
- GET /conversazioni?company_id=ID
  - Risposta: array di conversazioni (id, title, created_at, updated_at, summary)
- POST /documents (multipart/form-data)
  - Campo: document[original_file] = (PDF/IMG)
  - Risposta: { id, status, doc_type, ai_data, created_at, updated_at }
  - Avvia AnalyzeDocumentJob; usa polling GET /documents/:id finché `status` diventa `completed` o `failed`.
- GET /documents/:id
  - Stato: `pending` → `processing` → `completed` (o `failed` con ai_data.error)

Flussi Funzionali
- Generazione Conversazionale
  - Controller: app/controllers/generator_controller.rb
  - Servizio: app/services/ai_service.rb
    - Costruisce un `system_prompt` con nome e descrizione azienda + istruzioni del Tone
    - Normalizza lo storico dei messaggi (merge ruoli consecutivi, iniziare da `user`)
    - Chiama Bedrock Converse con `messages`, `system`, `inference_config`
    - Persistenza: salva `Message` (user/assistant) nella `Conversation`
    - Fallback: opzionale con `BEDROCK_FALLBACK_MODEL_ID`
  - Tester: public/tester.html (carica toni, gestisce conversazioni, genera output)

- Analisi Documenti
  - Modello: app/models/document.rb (Active Storage `original_file`, enum `status`)
  - Servizio: app/services/document_analysis_service.rb
    - Valida MIME (configurato in config/bedrock.yml → `supported_formats`)
    - Costruisce `media_block` (PDF o immagine) e un `prompt_block` per JSON
    - Converse con Bedrock (temperature 0.0, max_tokens configurabili)
    - Parsifica output testo isolando primo JSON e validandolo
  - Job: app/jobs/analyze_document_job.rb
    - Imposta stato `processing`, analizza, salva `doc_type` + `ai_data`, stato `completed`
    - Gestione errori: `DocumentAnalysisError` (failed), altrimenti retry (in dev queue async)
  - Tester: public/documentTester.html (upload file, polling status)

Architettura & Config
- Bedrock
  - File: config/bedrock.yml (profili `document_analysis`, `text_generation`)
  - Inizializzatore: config/initializers/bedrock_config.rb (carica per ambiente)
- Code AI
  - `AiService` usa profilo `text_generation`
  - `DocumentAnalysisService` usa profilo `document_analysis`
- Queue/Cache
  - Dev: `config.active_job.queue_adapter = :async`
  - Prod: SolidQueue + SolidCache
- Storage
  - Dev/Prod: `config.active_storage.service = :local` (vedi config/storage.yml per alternative)

Esempi Rapidi (curl)
- Genera testo
  curl -X POST http://localhost:3000/genera \
    -H "Content-Type: application/json" \
    -d '{"prompt":"Scrivi un email introduttiva","tone":"Formale","company_id":1}'
- Carica documento
  curl -X POST http://localhost:3000/documents \
    -F "document[original_file]=@C:/path/al/file.pdf"
- Stato documento
  curl http://localhost:3000/documents/ID

Docker/Deploy
- Dockerfile (produzione) incluso; avvio tipico:
  docker build -t nexum_poc .
  docker run -d -p 80:80 -e RAILS_MASTER_KEY=<master_key> \
    -e AWS_REGION=us-east-1 -e AWS_ACCESS_KEY_ID=... -e AWS_SECRET_ACCESS_KEY=... \
    --name nexum_poc nexum_poc
- Kamal: gem inclusa, vedi bin/kamal e config/deploy.yml

Troubleshooting
- `rails s` fallisce subito
  - Verifica: DB accessibile (utente/password/porta) e migrazioni eseguite (`db:migrate`)
  - Variabili AWS presenti se usi le funzionalità AI all’avvio
  - Chiavi Master: `config/master.key`/`RAILS_MASTER_KEY`
- Bedrock AccessDenied/Throttling
  - Modello abilitato nella regione configurata; prova `BEDROCK_FALLBACK_MODEL_ID`
- Formato non supportato in upload
  - Controlla `config/bedrock.yml → supported_formats`

Note di Sicurezza & CORS
- Le pagine HTML di test funzionano su stessa origin in dev.
- Per produzione, aggiungere autenticazione alle API e CORS mirato.

Riferimenti
- Rotte: config/routes.rb
- Tester: public/tester.html, public/documentTester.html
- Servizi AI: app/services/ai_service.rb, app/services/document_analysis_service.rb
- Modelli: app/models/*
- Job: app/jobs/analyze_document_job.rb
- Bedrock config: config/bedrock.yml, config/initializers/bedrock_config.rb
