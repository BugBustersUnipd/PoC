<!doctype html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>AI Generator Tester</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: 20px auto; }
    label { display: block; margin-top: 12px; }
    textarea { width: 100%; height: 140px; }
    select, input, button { padding: 6px; }
    .row { display: flex; gap: 12px; align-items: center; }
    .result, pre { background: #f5f5f5; padding: 10px; }
  </style>
</head>
<body>
  <h1>AI Generator Tester</h1>

  <label>Company ID
    <input id="companyId" type="number" value="1" />
  </label>

  <div class="row">
    <button id="loadTones">Carica toni</button>
    <span id="tonesStatus"></span>
  </div>

  <label>Tono
    <select id="toneSelect"></select>
  </label>

  <label>Prompt utente</label>
  <textarea id="prompt">Scrivi un'email di presentazione del prodotto.</textarea>

  <div class="row">
    <button id="generate">Genera</button>
    <span id="genStatus"></span>
  </div>

  <h3>Risultato</h3>
  <div class="result" id="output"></div>

  <script>
    const toneSelect = document.getElementById('toneSelect');
    const companyIdEl = document.getElementById('companyId');
    const promptEl = document.getElementById('prompt');
    const tonesStatus = document.getElementById('tonesStatus');
    const genStatus = document.getElementById('genStatus');
    const output = document.getElementById('output');

    async function loadTones() {
      const companyId = companyIdEl.value;
      tonesStatus.textContent = 'Carico...';
      toneSelect.innerHTML = '';  // Pulisci la select
      output.textContent = '';    // Pulisci l'output
      
      try {
        const res = await fetch(`/toni?company_id=${encodeURIComponent(companyId)}`);
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        (data.tones || []).forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.name;
          opt.textContent = `${t.name} â€” ${t.instructions || ''}`;
          toneSelect.appendChild(opt);
        });
        tonesStatus.textContent = `Toni caricati: ${(data.tones || []).length}`;
      } catch (err) {
        tonesStatus.textContent = `Errore: ${err.message}`;
      }
    }

    async function generate() {
      const body = {
        prompt: promptEl.value,
        tone: toneSelect.value,
        company_id: Number(companyIdEl.value)
      };
      genStatus.textContent = 'Genero...';
      output.textContent = '';
      try {
        const res = await fetch('/genera', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || res.statusText);
        output.textContent = data.text || JSON.stringify(data);
        genStatus.textContent = 'Fatto';
      } catch (err) {
        genStatus.textContent = `Errore: ${err.message}`;
      }
    }

    document.getElementById('loadTones').onclick = loadTones;
    document.getElementById('generate').onclick = generate;

    // Autocarica toni all'avvio
    loadTones();
  </script>
</body>
</html>